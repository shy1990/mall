<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.sanji.mall.order.dao.OrderMapper" >
  <resultMap id="BaseResultMap" type="com.sanji.mall.model.Order" >
    <id column="ID" jdbcType="VARCHAR" property="id" />
    <result column="MEMBER_ID" jdbcType="VARCHAR" property="memberId" />
    <result column="CREATETIME" jdbcType="TIMESTAMP" property="createtime" />
    <result column="SOURCE_TYPE" jdbcType="VARCHAR" property="sourceType" />
    <result column="SALE_TYPE" jdbcType="VARCHAR" property="saleType" />
    <result column="STATUS" jdbcType="VARCHAR" property="status" />
    <result column="PAY_STATUS" jdbcType="VARCHAR" property="payStatus" />
    <result column="SHIP_STATUS" jdbcType="VARCHAR" property="shipStatus" />
    <result column="KESH_STATUS" jdbcType="VARCHAR" property="keshStatus" />
    <result column="IS_DELIVERY" jdbcType="VARCHAR" property="isDelivery" />
    <result column="EXPRESS_ID" jdbcType="VARCHAR" property="expressId" />
    <result column="EXPRESS_NUM" jdbcType="VARCHAR" property="expressNum" />
    <result column="PAY_MENT" jdbcType="VARCHAR" property="payMent" />
    <result column="PAY_TIME" jdbcType="TIMESTAMP" property="payTime" />
    <result column="SHIP_NAME" jdbcType="VARCHAR" property="shipName" />
    <result column="AREA" jdbcType="VARCHAR" property="area" />
    <result column="SHIP_ZIP" jdbcType="VARCHAR" property="shipZip" />
    <result column="SHIP_TEL" jdbcType="VARCHAR" property="shipTel" />
    <result column="SHIP_EMAIL" jdbcType="VARCHAR" property="shipEmail" />
    <result column="SHIP_TIME" jdbcType="TIMESTAMP" property="shipTime" />
    <result column="TOTAL_COST" jdbcType="DECIMAL" property="totalCost" />
    <result column="CARRIAGE" jdbcType="DECIMAL" property="carriage" />
    <result column="ADVANCE" jdbcType="DECIMAL" property="advance" />
    <result column="EBANK_MON" jdbcType="DECIMAL" property="ebankMon" />
    <result column="REMARK" jdbcType="VARCHAR" property="remark" />
    <result column="MODIFYTIME" jdbcType="TIMESTAMP" property="modifytime" />
    <result column="ORDER_POINTS" jdbcType="DECIMAL" property="orderPoints" />
    <result column="PROVINCE" jdbcType="VARCHAR" property="province" />
    <result column="CITY" jdbcType="VARCHAR" property="city" />
    <result column="ADDRESS" jdbcType="VARCHAR" property="address" />
    <result column="MEMBER_TYPE" jdbcType="VARCHAR" property="memberType" />
    <result column="BILL_TYPE" jdbcType="VARCHAR" property="billType" />
    <result column="BILL_HEAD" jdbcType="VARCHAR" property="billHead" />
    <result column="BILL_CONTENT" jdbcType="VARCHAR" property="billContent" />
    <result column="DISABLED" jdbcType="VARCHAR" property="disabled" />
    <result column="ORDER_NUM" jdbcType="VARCHAR" property="orderNum" />
    <result column="LOGISTICS_TEL" jdbcType="VARCHAR" property="logisticsTel" />
    <result column="DEAL_ID" jdbcType="VARCHAR" property="dealId" />
    <result column="DEAL_TYPE" jdbcType="VARCHAR" property="dealType" />
    <result column="SIGNFORTIME" jdbcType="TIMESTAMP" property="signForTime" />
    <result column="ECERP_NO" jdbcType="VARCHAR" property="ecerpNo" />
    <result column="ECERP_CREATED" jdbcType="VARCHAR" property="ecerpCreated" />
    <result column="ECERP_ERROR" jdbcType="VARCHAR" property="ecerpError" />
    <result column="OVERMAN" jdbcType="VARCHAR" property="overMan" />
    <result column="OVERTIME" jdbcType="TIMESTAMP" property="overTime" />
    <!-- 扩展字段 -->
    <result column="PNAME" property="pname" jdbcType="VARCHAR" />
    <result column="CNAME" property="cname" jdbcType="VARCHAR" />
    <result column="ANAME" property="aname" jdbcType="VARCHAR" />
    <result column="USERNAME" property="userName" jdbcType="VARCHAR" />
    <!-- 后来添加钱包支付，追加的字段 -->
    <result column="WALLET_NUM" jdbcType="DECIMAL" property="walletNum" />
    <result column="ACTUAL_PAY_NUM" jdbcType="DECIMAL" property="actualPayNum" />
    <result column="WALLET_PAY_NO" jdbcType="VARCHAR" property="walletPayNo" />
    <!-- 后来追加红包相关字段 -->
    <result column="HB_NO" jdbcType="VARCHAR" property="hbNo" />
    <result column="HB_NUM" jdbcType="DECIMAL" property="hbNum" />
    
  </resultMap> 
  
  <!-- 订单相关信息  -->  
  <resultMap type="com.sanji.mall.model.Order" id="orderDetailMap" extends="BaseResultMap">
 	<!-- 订单详情 -->
 	<collection property="orderItemss" ofType="com.sanji.mall.model.OrderItems"  >
 		<id column="Items_ID" property="id" jdbcType="VARCHAR" />
	    <result column="ITEMS_ORDER_ID" property="orderId" jdbcType="VARCHAR" />
	    <result column="ITEMS_TARGET_ID" property="targetId" jdbcType="VARCHAR" />
	    <result column="ITEMS_TARGET_TYPE" property="targetType" jdbcType="VARCHAR" />
	    <result column="ITEMS_MARKETBALE_PRICE" property="marketbalePrice" jdbcType="DECIMAL" />
	    <result column="ITEMS_DEAL_PRICE" property="dealPrice" jdbcType="DECIMAL" />
	    <result column="ITEMS_AMOUNT" property="amount" jdbcType="DECIMAL" />
	    <result column="ITEMS_NUMS" property="nums" jdbcType="DECIMAL" />
	    <result column="ITEMS_SALE_ACTIVE_ID" property="saleActiveId" jdbcType="VARCHAR" />
	    <result column="ITEMS_SALE_ACTIVE_REDUCE_MONEY" property="saleActiveReduceMoney" jdbcType="DECIMAL" />
	    <result column="ITEMS_MEMBERLV_REDCE_MONEY" property="memberlvRedceMoney" jdbcType="DECIMAL" />
	    <result column="ITEMS_MEMBERLV_DISCOUNT" property="memberlvDiscount" jdbcType="DECIMAL" />
	    <result column="ITEMS_APPRAISE" property="appraise" jdbcType="VARCHAR" />
	    <result column="ITEMS_ISGIFT" property="isgift" jdbcType="VARCHAR" />
	    <result column="ITEMS_ROOT_NUM" property="rootNum" jdbcType="DECIMAL" />
	    <result column="items_th_status" property="status" jdbcType="DECIMAL" />
	    
	    <!-- 订单关联的单品信息 --> 
	    <collection property="goodsSku" ofType="com.sanji.mall.model.GoodsSku"  >
	    	<id column="sku_id" property="id" jdbcType="VARCHAR" />
	  		<result column="sku_num" property="skuNum" jdbcType="VARCHAR" />
	  		<result column="sku_edition" property="edition" jdbcType="NUMERIC" />
	  		<result column="sku_standard" property="standard" jdbcType="VARCHAR" />
	  		<result column="sku_netSuitType" property="netSuitType" jdbcType="VARCHAR" />
	  		<result column="sku_stock" property="stock" jdbcType="VARCHAR" />
	  		<result column="sku_code" property="skuCode" jdbcType="VARCHAR" />
	  		<collection property="goods" javaType="com.sanji.mall.model.Goods" >
			  	<id column="GOODS_ID" jdbcType="VARCHAR" property="id" />
			    <result column="GOODS_NAME" jdbcType="VARCHAR" property="name" />
			    <result column="GOODS_NUM" jdbcType="VARCHAR" property="goodsNum" />
			    <result column="GOODS_TYPE" jdbcType="VARCHAR" property="type" />
			    <result column="GOODS_CLICK_RATE" jdbcType="VARCHAR" property="clickRate" />
			    <result column="goods_DEFAULT_IMG" jdbcType="VARCHAR" property="defaultImg" />
			    <!-- 品牌信息 -->
			  	<collection property="brand"  ofType="com.sanji.mall.model.Brand">
			  		<id column="sku_brand_id" property="id" jdbcType="VARCHAR" /> 
			  		<result column="sku_brand_name" property="name" jdbcType="VARCHAR" />
			  	</collection>
		  	</collection>
		  	<!-- 单品颜色 -->
		  	<collection property="color"  ofType="com.sanji.mall.model.Color">
		  		<id column="sku_cl_id" property="id" jdbcType="DECIMAL" />
			    <result column="sku_cl_color_name" property="colorName" jdbcType="VARCHAR" />
		  	</collection>
	    </collection>
	    
	    <!-- 订单关联的配件信息 -->
	    <collection property="accessory" ofType="com.sanji.mall.model.Accessory" >
	    	<id column="acs_ID" property="id" jdbcType="VARCHAR" />
			<result column="acs_NAME" property="name" jdbcType="VARCHAR" />
			<result column="acs_ACCESSORIES_NUM" property="accessoriesNum" jdbcType="VARCHAR" />
			<result column="acs_DEFAULT_IMG" property="defaultImg" jdbcType="VARCHAR" />
			<result column="acs_STYLES" property="styles" jdbcType="VARCHAR" />
			<result column="acs_ACCESSORIES_STYLE" property="accessoriesStyle" jdbcType="VARCHAR" />
			<result column="acs_STOCK" property="stock" jdbcType="DECIMAL" />
	    	<result column="acs_CLICK_RATE" property="clickRate" jdbcType="DECIMAL" />
	    	<result column="acs_SPEC_CODE" property="specCode" jdbcType="VARCHAR" />
	    	<!-- 单品颜色 -->
		  	<collection property="colors"  ofType="com.sanji.mall.model.Color">
		  		<id column="acs_cl_id" property="id" jdbcType="DECIMAL" />
			    <result column="acs_cl_color_name" property="colorName" jdbcType="VARCHAR" />
		  	</collection>
		  	<!-- 品牌信息 --> 
		  	<collection property="brand"  ofType="com.sanji.mall.model.Brand">
		  		<id column="acs_brand_id" property="id" jdbcType="VARCHAR" /> 
		  		<result column="acs_brand_name" property="name" jdbcType="VARCHAR" />
		  	</collection>
	    </collection> 
	    
	    <!-- 订单关联的积分商品信息 -->
	    <collection property="pointGoods" ofType="com.sanji.mall.model.PointGoods" >
	    	<id column="point_Id" jdbcType="VARCHAR" property="id" />
			<result column="point_name" jdbcType="VARCHAR" property="name" />
			<result column="point_type" property="type"/>
			<result column="point_price" jdbcType="DECIMAL" property="price" />
			<result column="point_integral" jdbcType="DECIMAL" property="integral" />
			<result column="point_pic" jdbcType="VARCHAR" property="pic" />
			<result column="pg_stock" jdbcType="VARCHAR" property="stock" />
			<result column="pg_integralCode" jdbcType="VARCHAR" property="integralCode" />
			<result column="pg_specCode" jdbcType="VARCHAR" property="specCode" />
	    </collection> 

	    <!-- 订单关联的赠品信息 -->
	    <collection property="gift" ofType="com.sanji.mall.model.Gift" >
	    	<id column="gift_id" property="id" jdbcType="VARCHAR" />
			<result column="GIFT_PRICE" property="giftPrice" jdbcType="DECIMAL" />
		    <collection property="accessory" ofType="com.sanji.mall.model.Accessory" >
		    	<id column="gacs_ID" property="id" jdbcType="VARCHAR" />
				<result column="gacs_NAME" property="name" jdbcType="VARCHAR" />
				<result column="gacs_ACCESSORIES_NUM" property="accessoriesNum" jdbcType="VARCHAR" />
				<result column="gacs_DEFAULT_IMG" property="defaultImg" jdbcType="VARCHAR" />
				<result column="gacs_STYLES" property="styles" jdbcType="VARCHAR" />
				<result column="gacs_ACCESSORIES_STYLE" property="accessoriesStyle" jdbcType="VARCHAR" />
				<result column="gacs_STOCK" property="stock" jdbcType="DECIMAL" />
		    	<result column="gacs_CLICK_RATE" property="clickRate" jdbcType="DECIMAL" />
		    	<result column="gacs_SPEC_CODE" property="specCode" jdbcType="VARCHAR" />
		    	<!-- 单品颜色 -->
			  	<collection property="colors"  ofType="com.sanji.mall.model.Color">
			  		<id column="gacs_cl_id" property="id" jdbcType="DECIMAL" />
				    <result column="gacs_cl_color_name" property="colorName" jdbcType="VARCHAR" />
			  	</collection>
			  	<!-- 品牌信息 -->  
			  	<collection property="brand"  ofType="com.sanji.mall.model.Brand">
			  		<id column="gacs_brand_id" property="id" jdbcType="VARCHAR" /> 
			  		<result column="gacs_brand_name" property="name" jdbcType="VARCHAR" />
			  	</collection>
		    </collection> 
		</collection>
		
 	</collection> 
  </resultMap>
  
  <sql id="Base_Column_List" >
    ID, MEMBER_ID, CREATETIME, SOURCE_TYPE, SALE_TYPE, STATUS, PAY_STATUS, SHIP_STATUS, 
    KESH_STATUS, IS_DELIVERY, EXPRESS_ID, EXPRESS_NUM, PAY_MENT, PAY_TIME, SHIP_NAME, 
    AREA, SHIP_ZIP, SHIP_TEL, SHIP_EMAIL, SHIP_TIME, TOTAL_COST, CARRIAGE, ADVANCE, EBANK_MON, 
    REMARK, MODIFYTIME, ORDER_POINTS, PROVINCE, CITY, ADDRESS, MEMBER_TYPE, BILL_TYPE, 
    BILL_HEAD, BILL_CONTENT, DISABLED, ORDER_NUM, LOGISTICS_TEL, DEAL_ID, DEAL_TYPE ,ECERP_NO,ECERP_CREATED,ECERP_ERROR,WALLET_NUM,ACTUAL_PAY_NUM,WALLET_PAY_NO,HB_NUM,HB_NO
  </sql>
  
  <!-- 订单相关所有需要查询的字段 -->
  <sql id="Base_Column_List_Detail">
  	o.ID, o.MEMBER_ID, o.CREATETIME, o.SOURCE_TYPE, o.SALE_TYPE, o.STATUS, o.PAY_STATUS, o.SHIP_STATUS, 
    o.KESH_STATUS, o.IS_DELIVERY, o.EXPRESS_ID, o.EXPRESS_NUM, o.PAY_MENT, o.PAY_TIME, o.SHIP_NAME, 
    o.AREA, o.SHIP_ZIP, o.SHIP_TEL, o.SHIP_EMAIL, o.SHIP_TIME, o.TOTAL_COST, o.CARRIAGE, o.ADVANCE, o.EBANK_MON, 
    o.REMARK, o.MODIFYTIME, o.ORDER_POINTS, o.PROVINCE, o.CITY, o.ADDRESS, o.MEMBER_TYPE, o.BILL_TYPE, 
    o.BILL_HEAD, o.BILL_CONTENT, o.DISABLED, o.ORDER_NUM, o.LOGISTICS_TEL, o.DEAL_ID, o.DEAL_TYPE,o.SIGNFORTIME,o.WALLET_NUM,o.ACTUAL_PAY_NUM,o.WALLET_PAY_NO,HB_NUM,HB_NO,
  	items.id Items_ID, items.order_id ITEMS_ORDER_ID,items.TARGET_ID ITEMS_TARGET_ID,items.TARGET_TYPE ITEMS_TARGET_TYPE,
  	items.marketbale_price ITEMS_MARKETBALE_PRICE,items.deal_price ITEMS_DEAL_PRICE,items.amount ITEMS_AMOUNT,
  	items.nums ITEMS_NUMS,items.sale_active_id ITEMS_SALE_ACTIVE_ID,items.sale_active_reduce_money ITEMS_SALE_ACTIVE_REDUCE_MONEY,
  	items.memberlv_redce_money ITEMS_MEMBERLV_REDCE_MONEY,items.memberlv_discount ITEMS_MEMBERLV_DISCOUNT,
  	items.appraise ITEMS_APPRAISE,items.isgift ITEMS_ISGIFT,items.root_num ITEMS_ROOT_NUM,
  	sku.id sku_id,sku.SKU_NUM sku_num,sku.edition sku_edition,sku.standard sku_standard,sku.net_Suit_Type sku_netSuitType,
  	sku.stock sku_stock ,sku.sku_code,
  	goods.id GOODS_ID,goods.name GOODS_NAME,goods.goods_Num GOODS_NUM,goods.type GOODS_TYPE,goods.click_Rate GOODS_CLICK_RATE,
  	goods.DEFAULT_IMG goods_DEFAULT_IMG, 
  	skuBrand.Id sku_brand_id,skuBrand.Name sku_brand_name,
  	skuCl.id sku_cl_id, skuCl.color_Name sku_cl_color_name, 
  	acs.id acs_ID,acs.name acs_NAME,acs.accessories_Num acs_ACCESSORIES_NUM,acs.default_Img acs_DEFAULT_IMG,acs.styles acs_STYLES, 
  	acs.accessories_Style acs_ACCESSORIES_STYLE,acs.stock acs_STOCK,acs.click_Rate acs_CLICK_RATE, acs.SPEC_CODE acs_SPEC_CODE,
  	acsCl.id acs_cl_id,acsCl.color_Name acs_cl_color_name, 
  	acsBrand.id acs_brand_id,acsBrand.name acs_brand_name,
  	pg.id point_Id, pg.NAME point_name, pg.PRICE point_price, pg.INTEGRAL point_integral, 
  	pg.PIC point_pic, pg.TYPE point_type,pg.stock pg_stock,pg.INTEGRAL_CODE pg_integralCode,pg.SPEC_CODE pg_specCode,
  	gift.id gift_id,gift.GIFT_PRICE GIFT_PRICE,
  	gacs.id gacs_ID,gacs.name gacs_NAME,gacs.accessories_Num gacs_ACCESSORIES_NUM,gacs.default_Img gacs_DEFAULT_IMG,gacs.styles gacs_STYLES, 
  	gacs.accessories_Style gacs_ACCESSORIES_STYLE,gacs.stock gacs_STOCK,gacs.click_Rate gacs_CLICK_RATE, gacs.SPEC_CODE gacs_SPEC_CODE,
  	gacsCl.id gacs_cl_id,gacsCl.color_Name gacs_cl_color_name, 
  	gacsBrand.id gacs_brand_id,gacsBrand.name gacs_brand_name ,
  	items.th_status items_th_status
  	<!--
  	thItem.id thItem_id, thItem.quantity thItem_quantity, thItem.price thItem_price,
  	thForm.id thForm_id,thForm.create_time thForm_create_time,thForm.status thForm_status -->
  	
  </sql>
  <!-- 分页获取数据的时候需要的接收字段 -->
  <sql id="Base_Column_List_Detail_page">
  	ID, MEMBER_ID, CREATETIME, SOURCE_TYPE, SALE_TYPE, STATUS, PAY_STATUS, SHIP_STATUS, 
    KESH_STATUS, IS_DELIVERY, EXPRESS_ID, EXPRESS_NUM, PAY_MENT, PAY_TIME, SHIP_NAME, 
    AREA, SHIP_ZIP, SHIP_TEL, SHIP_EMAIL, SHIP_TIME, TOTAL_COST, CARRIAGE, ADVANCE, EBANK_MON, 
    REMARK, MODIFYTIME, ORDER_POINTS, PROVINCE, CITY, ADDRESS, MEMBER_TYPE, BILL_TYPE, 
    BILL_HEAD, BILL_CONTENT, DISABLED, ORDER_NUM, LOGISTICS_TEL, DEAL_ID, DEAL_TYPE,SIGNFORTIME,
  	Items_ID,ITEMS_ORDER_ID,ITEMS_TARGET_ID,ITEMS_TARGET_TYPE,ITEMS_MARKETBALE_PRICE,ITEMS_DEAL_PRICE,ITEMS_AMOUNT,ITEMS_NUMS,
	ITEMS_SALE_ACTIVE_ID,ITEMS_SALE_ACTIVE_REDUCE_MONEY,ITEMS_MEMBERLV_REDCE_MONEY,ITEMS_MEMBERLV_DISCOUNT,ITEMS_APPRAISE,
	ITEMS_ISGIFT,ITEMS_ROOT_NUM,items_th_status,
	sku_id,sku_num,sku_edition,sku_standard,sku_netSuitType, sku_stock,
	GOODS_ID,GOODS_NAME,GOODS_NUM,GOODS_TYPE,GOODS_CLICK_RATE,goods_DEFAULT_IMG, 
	sku_brand_id,sku_brand_name,
	sku_cl_id,sku_cl_color_name,
	acs_ID,acs_NAME,acs_ACCESSORIES_NUM,acs_DEFAULT_IMG,acs_STYLES,acs_ACCESSORIES_STYLE,acs_STOCK,acs_CLICK_RATE,
	acs_cl_id,acs_cl_color_name,
	acs_brand_id,acs_brand_name,acs_SPEC_CODE,
  	PNAME,CNAME,ANAME,
  	point_Id,point_name,point_price,point_integral,point_pic,point_type,pg_stock,
  	gift_id, GIFT_PRICE,
  	gacs_ID,gacs_NAME,gacs_ACCESSORIES_NUM, gacs_DEFAULT_IMG,gacs_STYLES, 
  	gacs_ACCESSORIES_STYLE,gacs_STOCK,gacs_CLICK_RATE, gacs_SPEC_CODE,
  	gacs_cl_id,gacs_cl_color_name, gacs_brand_id, gacs_brand_name<!-- ,
  	thItem_id,thItem_quantity,thItem_price,thForm_id,thForm_create_time,thForm_status -->
  </sql>
  
  <!-- 基础查询sql -->
  <sql id="select_base_sql">
  	select <include refid="Base_Column_List_Detail" />,
  	(select R1."NAME" from SJ_TB_REGIONS R1 where R1."ID" = o.PROVINCE) as PNAME,
	(select R1."NAME" from SJ_TB_REGIONS R1 where R1."ID" = o.CITY) as CNAME,
	(select R1."NAME" from SJ_TB_REGIONS R1 where R1."ID" = o.area) ANAME
  	from sj_tb_order o  
  	left join sj_tb_order_items items on o.id=items.ORDER_ID
  	left join sj_tb_goods_sku sku on items.TARGET_ID=sku.id 
  	left join sj_tb_goods goods on sku.goods_id=goods.id 
  	left join sj_tb_brand skuBrand on goods.brand_id = skuBrand.id
  	left join sj_tb_color skuCl on sku.color_id=skuCl.id
  	left join sj_tb_accessories acs on items.target_id=acs.id
  	left join sj_tb_brand acsBrand on acs.brand_id=acsBrand.id
  	left join sj_tb_color acsCl on acs.color_id=acsCl.id
  	<!-- 追加积分商品 -->
  	left join sj_tb_integral_goods pg on items.TARGET_ID=pg.id
  	<!-- 追加查询赠品信息 -->
  	left join sj_tb_gift gift on items.target_id=gift.id
  	left join sj_tb_accessories gacs on gift.GIFT_ID=gacs.id
  	left join sj_tb_brand gacsBrand on gacs.brand_id=gacsBrand.id
  	left join sj_tb_color gacsCl on gacs.color_id=gacsCl.id
  	<!-- 追加关联 退款退货记录 
  	left join sj_tb_th_item thItem on items.id=thItem.order_items_id
  	left join sj_tb_th_form thForm on thItem.form_id=thForm.id
  	-->
  	
  	where o.DISABLED='false'
  	
  	<if test="userId!=null and userId!=''">
  		and o.MEMBER_ID=#{userId,jdbcType=VARCHAR}
  	</if>

  	<!-- 如果id是空那么就根据分页获得oid列表，然后再取数据in -->
  	<if test="id==null or id==''">
  		and o.id in(<include refid="select_ordersIds_sql" />)
  	</if>
  	<!-- 根据订单id获取订单数据 -->
  	<if test="id!=null and id!=''">
  		and o.id=#{id,jdbcType=VARCHAR}
  	</if>
  	
  	<choose>
       <when test="sort != null &amp;&amp; sort != '' ">
          order by o.${sort} ${order}
       </when>
       <otherwise>
           order by o.CREATETIME desc
       </otherwise>
    </choose>
  </sql>
  <!-- 根据订单号查询业务员手机号 -->
  <select id="gainAdminMobileByOrderNum" resultType="java.lang.String" parameterType="java.lang.String">
   select a.mobilephone from sj_tb_admin a left join sj_tb_members m on m.admin_id = a.id left join sj_tb_order o on o.member_id = m.id where o.order_num = #{orderNum,jdbcType=VARCHAR}
  </select>
  <!-- 根据订单号查询订单物流状态 -->
  <select id="gainShipStatusBuyOrderNum" resultType="java.lang.String" parameterType="java.lang.String">
    select o.ship_status from sj_tb_order o where o.order_num = #{orderNum,jdbcType=VARCHAR}
  </select>
  <!-- 根据订单号查询订单信息 -->
  <select id="gainOrderInfoByOrderCode" resultMap="BaseResultMap" parameterType="java.lang.String">
    select o.order_num as orderNum ,o.total_cost as totalCost,o.SHIP_TEL as shipTel ,o.ship_name as shipName ,o.ship_status as shipStatus from  sj_tb_order o  where (o.order_num = #{orderCode,jdbcType=VARCHAR} or o.ECERP_NO = #{orderCode,jdbcType=VARCHAR})
  </select>
  
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />
    from SJ_TB_ORDER
    where ID = #{id,jdbcType=VARCHAR}
  </select>
  <!--批量推送订单的sql 慎用  -->
  <select id="getSomeOrder" resultMap="BaseResultMap" >
    select 
    <include refid="Base_Column_List" />
    from SJ_TB_ORDER
    where    order_num  >='201602191420'
<!-- AND (ECERP_NO IS  NULL or ECERP_NO='null') -->
AND status    ='0' and
pay_ment='1' <!-- and PAY_STATUS='1'  -->
  </select>
  
   
  <!-- 分页获取订单列表信息 -->
  <select id="gainPageOrders" resultMap="orderDetailMap" parameterType="java.util.Map" >
  	<!-- select <include refid="Base_Column_List_Detail_page" /> from (
  		select RN,<include refid="Base_Column_List_Detail_page" /> from (
  			select ROWNUM AS RN,<include refid="Base_Column_List_Detail_page" /> from(
			    <include refid="select_base_sql" />
			)
  		)where <![CDATA[RN <= #{page}*#{rows}]]>
  	) where  RN>(#{page}-1)*#{rows} -->
  	<include refid="select_base_sql" />
  </select>
  
  <!-- 分页获取订单id列表 -->
  <sql id="select_ordersIds_sql" >
  	select id from (
  		select RN,id from (
  			select ROWNUM AS RN,id from(
  				select distinct id,createtime <if test="sort != null">,${sort}</if> from(
				    select o.id,o.createtime
				    <if test="sort != null">
				    	,o.${sort} 
				    </if>
				  	from sj_tb_order o  
				  	left join sj_tb_order_items items on o.id=items.ORDER_ID
				  	left join sj_tb_goods_sku sku on items.TARGET_ID=sku.id 
				  	left join sj_tb_goods goods on sku.goods_id=goods.id
				  	left join sj_tb_brand skuBrand on goods.brand_id = skuBrand.id
				  	left join sj_tb_color skuCl on sku.color_id=skuCl.id
				  	left join sj_tb_accessories acs on items.target_id=acs.id
				  	left join sj_tb_brand acsBrand on acs.brand_id=acsBrand.id
				  	left join sj_tb_color acsCl on acs.color_id=acsCl.id
				  	where o.MEMBER_ID=#{userId,jdbcType=VARCHAR} and o.DISABLED='false'
				  	<!-- 根据订单id获取订单数据 -->
				  	<if test="id!=null and id!=''">
				  		and o.id=#{id,jdbcType=VARCHAR}
				  	</if>
				  	<!-- 根据订单编号获取订单数据 -->
				  	<if test="orderNum!=null and orderNum!=''">
				  		and o.ORDER_NUM=#{orderNum,jdbcType=VARCHAR}
				  	</if>
				  	<!-- 根据评价状态获取订单数据 -->
				  	<if test="saleType!=null and saleType!=''">
				  		and o.SALE_TYPE=#{saleType,jdbcType=VARCHAR}
				  	</if>
				  	<!-- 根据订单状态获取订单数据 -->
				  	<if test="status!=null and status!=''">
				  		and o.STATUS=#{status,jdbcType=VARCHAR}
				  	</if>
				  	<!-- 根据订单支付状态获取订单数据 -->
				  	<if test="payStatus!=null and payStatus!=''">
				  		and o.PAY_STATUS=#{payStatus,jdbcType=VARCHAR}
				  		<!-- 根据订单发货状态获取订单数据,查询此条件要付款状态为1已付款 -->
					  	<if test="shipStatus!=null and shipStatus!=''">
					  		and o.SHIP_STATUS=#{shipStatus,jdbcType=VARCHAR}
					  		<!-- and o.PAY_STATUS=1 -->
					  	</if>
				  	</if>
				  	<!-- 模糊查找 --> 
				    <if test="searchParam != null and searchParam != ''">
				    	and goods.name like '%${searchParam}%' 
				    	or o.ORDER_NUM like '%${searchParam}%' 
				    	or acs.name like '%${searchParam}%' 
				    </if>
				  	
				)<!-- group by id -->
				<!-- 根据时间排序，以后有别的条件再改此处 -->
			    <!-- order by CREATETIME desc -->
			    
			    <choose>
			       <when test="sort != null &amp;&amp; sort != '' ">
			          order by ${sort} ${order}
			       </when>
			       <otherwise>
			           order by CREATETIME desc
			       </otherwise>
			    </choose> 
			    
			)
  		)where <![CDATA[RN <= #{page}*#{rows}]]>
  	) where  RN>(#{page}-1)*#{rows}
  </sql>
  
  <!-- 获取订单详情 -->
  <select id="gainDetail" resultMap="orderDetailMap" parameterType="java.util.Map" >
  	<include refid="select_base_sql" />
  </select> 
  
  <!-- 统计数量 -->
  <select id="gainCountNum" resultType="java.lang.String" parameterType="java.util.Map" >
  	select count(*) from (
  		select id from (
		    select o.id
		  	from sj_tb_order o  
		  	left join sj_tb_order_items items on o.id=items.ORDER_ID
		  	left join sj_tb_goods_sku sku on items.TARGET_ID=sku.id 
		  	left join sj_tb_goods goods on sku.goods_id=goods.id
		  	left join sj_tb_brand skuBrand on goods.brand_id = skuBrand.id
		  	left join sj_tb_color skuCl on sku.color_id=skuCl.id
		  	left join sj_tb_accessories acs on items.target_id=acs.id
		  	left join sj_tb_brand acsBrand on acs.brand_id=acsBrand.id
		  	left join sj_tb_color acsCl on acs.color_id=acsCl.id
		  	where o.MEMBER_ID=#{userId,jdbcType=VARCHAR} and o.DISABLED='false'
		  	<!-- 根据订单id获取订单数据 -->
		  	<if test="id!=null and id!=''">
		  		and o.id=#{id,jdbcType=VARCHAR}
		  	</if>
		  	<!-- 根据订单编号获取订单数据 -->
		  	<if test="orderNum!=null and orderNum!=''">
		  		and o.ORDER_NUM=#{orderNum,jdbcType=VARCHAR}
		  	</if>
		  	<!-- 根据评价状态获取订单数据 -->
		  	<if test="saleType!=null and saleType!=''">
		  		and o.SALE_TYPE=#{saleType,jdbcType=VARCHAR}
		  	</if>
		  	<!-- 根据订单状态获取订单数据 -->
		  	<if test="status!=null and status!=''">
		  		and o.STATUS=#{status,jdbcType=VARCHAR}
		  	</if>
		  	<!-- 根据订单支付状态获取订单数据 -->
		  	<if test="payStatus!=null and payStatus!=''">
		  		and o.PAY_STATUS=#{payStatus,jdbcType=VARCHAR}
		  		<!-- 根据订单发货状态获取订单数据,查询此条件要付款状态为1已付款 -->
			  	<if test="shipStatus!=null and shipStatus!=''">
			  		and o.SHIP_STATUS=#{shipStatus,jdbcType=VARCHAR}
			  		<!-- and o.PAY_STATUS=1 -->
			  	</if>
		  	</if>
		  	<!-- 模糊查找 -->
		    <if test="searchParam != null and searchParam != ''">
		    	and goods.name like '%${searchParam}%' 
		    	or o.ORDER_NUM like '%${searchParam}%' 
		    	or acs.name like '%${searchParam}%' 
		    </if>
		  	<choose>
		       <when test="sort != null &amp;&amp; sort != '' ">
		          order by o.${sort} ${order}
		       </when>
		       <otherwise>
		           order by o.CREATETIME desc
		       </otherwise>
		    </choose> 
	  	)group by id
  	)
  </select> 
  <!-- 根据订单编号查询订单信息 -->
  <select id = "gainOrderByOrderNo" resultType = "com.sanji.mall.model.Order" parameterType="java.lang.String">
  	select 
	  	ID, MEMBER_ID as memberId, CREATETIME, SOURCE_TYPE as sourceType, SALE_TYPE as saleType, STATUS, 
	  	PAY_STATUS as payStatus, SHIP_STATUS as shipStatus, KESH_STATUS as keshStatus, IS_DELIVERY as Delivery, 
	  	EXPRESS_ID as expressId, EXPRESS_NUM as expressNum, PAY_MENT as payMent, PAY_TIME as payTime, SHIP_NAME as shipName, 
	    AREA, SHIP_ZIP as shipZip, SHIP_TEL as shipTel, SHIP_EMAIL as shipEmail, SHIP_TIME as shipTime, TOTAL_COST as totalCost, 
	    CARRIAGE, ADVANCE, EBANK_MON as ebankMon, REMARK, MODIFYTIME, ORDER_POINTS as orderPoints, PROVINCE, CITY, ADDRESS,
	    MEMBER_TYPE as memberType, BILL_TYPE as billType, BILL_HEAD as billHead, BILL_CONTENT as billContent, DISABLED, 
	    ORDER_NUM as orderNum, LOGISTICS_TEL as logisticsTel, DEAL_ID as dealId, DEAL_TYPE as dealType
  	from SJ_TB_ORDER
    where DISABLED='false' and ORDER_NUM = #{orderNum,jdbcType=VARCHAR}
  </select>
  <!-- 根据订单编号修改订单发货状态 -->
  <update id = "updateShipStatusByOrderNo" parameterType="com.sanji.mall.model.Order">
  	update SJ_TB_ORDER
  		<set>
	  	   <if test="shipStatus != null" >
	       	SHIP_STATUS = #{shipStatus,jdbcType=VARCHAR},
	       </if>
	       <if test="overMan != null and overMan != ''" >
	       	OVERMAN = #{overMan,jdbcType=VARCHAR},
	       </if>
	       <if test="overTime != null and overTime != ''" >
	       	OVERTIME = #{overTime,jdbcType=VARCHAR},
	       </if>
      	</set>
      	where 1 = 1 and (ORDER_NUM = #{orderCode,jdbcType=VARCHAR} or ECERP_NO = #{orderCode,jdbcType=VARCHAR})
  </update>
  
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    delete from SJ_TB_ORDER
    where ID = #{id,jdbcType=VARCHAR}
  </delete>
  <update id="updatePrice">
		update SJ_TB_ORDER set TOTAL_COST=#{totalCost,jdbcType=DECIMAL}, REMARK=#{remark,jdbcType=VARCHAR} ,WALLET_NUM=#{walletNum,jdbcType=DECIMAL},ACTUAL_PAY_NUM=#{actualPayNum,jdbcType=DECIMAL},
		WALLET_PAY_NO=#{walletPayNo,jdbcType=VARCHAR}
		where id=#{id,jdbcType=VARCHAR}
		  
	</update>
	
	<select id="updatePriceByMid" parameterType="java.lang.String" resultType="map">
	   select count(*) count from SJ_TB_ORDER where
		CREATETIME between TRUNC(SYSDATE)+1/(24*60*60) and TRUNC(SYSDATE+1)-1/(24*60*60)
		and TOTAL_COST>=2000 and pay_ment='0' and pay_status='1' and MEMBER_ID=#{MemberId,jdbcType=VARCHAR}
    </select>
  
  <!-- 根据用户id和订单id列表删除订单 -->
  <delete id="delBymidOids" parameterType="java.lang.String" >
    delete from SJ_TB_ORDER
    where ID = #{id,jdbcType=VARCHAR}
  </delete>
  
  <!-- 根据用户id和订单 -->
  <update id="upDisabledByUid"> 
  	update SJ_TB_ORDER set DISABLED = 'true' where MEMBER_ID=#{userId,jdbcType=VARCHAR} and ID in(#{ids,jdbcType=VARCHAR})
  </update>
   
  <insert id="insert" parameterType="com.sanji.mall.model.Order" >
    insert into SJ_TB_ORDER (ID, MEMBER_ID, CREATETIME, 
      SOURCE_TYPE, SALE_TYPE, STATUS, 
      PAY_STATUS, SHIP_STATUS, KESH_STATUS, 
      IS_DELIVERY, EXPRESS_ID, EXPRESS_NUM, 
      PAY_MENT, PAY_TIME, SHIP_NAME, 
      AREA, SHIP_ZIP, SHIP_TEL, 
      SHIP_EMAIL, SHIP_TIME, TOTAL_COST, 
      CARRIAGE, ADVANCE, EBANK_MON, 
      REMARK, MODIFYTIME, ORDER_POINTS, 
      PROVINCE, CITY, ADDRESS, 
      MEMBER_TYPE, BILL_TYPE, BILL_HEAD, 
      BILL_CONTENT, DISABLED, ORDER_NUM, 
      LOGISTICS_TEL, DEAL_ID, DEAL_TYPE 
      )
    values (#{id,jdbcType=VARCHAR}, #{memberId,jdbcType=VARCHAR}, #{createtime,jdbcType=TIMESTAMP}, 
      #{sourceType,jdbcType=VARCHAR}, #{saleType,jdbcType=VARCHAR}, #{status,jdbcType=VARCHAR}, 
      #{payStatus,jdbcType=VARCHAR}, #{shipStatus,jdbcType=VARCHAR}, #{keshStatus,jdbcType=VARCHAR}, 
      #{isDelivery,jdbcType=VARCHAR}, #{expressId,jdbcType=VARCHAR}, #{expressNum,jdbcType=VARCHAR}, 
      #{payMent,jdbcType=VARCHAR}, #{payTime,jdbcType=TIMESTAMP}, #{shipName,jdbcType=VARCHAR}, 
      #{area,jdbcType=VARCHAR}, #{shipZip,jdbcType=VARCHAR}, #{shipTel,jdbcType=VARCHAR}, 
      #{shipEmail,jdbcType=VARCHAR}, #{shipTime,jdbcType=TIMESTAMP}, #{totalCost,jdbcType=DECIMAL}, 
      #{carriage,jdbcType=DECIMAL}, #{advance,jdbcType=DECIMAL}, #{ebankMon,jdbcType=DECIMAL}, 
      #{remark,jdbcType=VARCHAR}, #{modifytime,jdbcType=TIMESTAMP}, #{orderPoints,jdbcType=DECIMAL}, 
      #{province,jdbcType=VARCHAR}, #{city,jdbcType=VARCHAR}, #{address,jdbcType=VARCHAR}, 
      #{memberType,jdbcType=VARCHAR}, #{billType,jdbcType=VARCHAR}, #{billHead,jdbcType=VARCHAR}, 
      #{billContent,jdbcType=VARCHAR}, #{disabled,jdbcType=VARCHAR}, #{orderNum,jdbcType=VARCHAR}, 
      #{logisticsTel,jdbcType=VARCHAR}, #{dealId,jdbcType=VARCHAR}, #{dealType,jdbcType=VARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.sanji.mall.model.Order" >
    insert into SJ_TB_ORDER
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        ID,
      </if>
      <if test="memberId != null" >
        MEMBER_ID,
      </if>
      <if test="createtime != null" >
        CREATETIME,
      </if>
      <if test="sourceType != null" >
        SOURCE_TYPE,
      </if>
      <if test="saleType != null" >
        SALE_TYPE,
      </if>
      <if test="status != null" >
        STATUS,
      </if>
      <if test="payStatus != null" >
        PAY_STATUS,
      </if>
      <if test="shipStatus != null" >
        SHIP_STATUS,
      </if>
      <if test="keshStatus != null" >
        KESH_STATUS,
      </if>
      <if test="isDelivery != null" >
        IS_DELIVERY,
      </if>
      <if test="expressId != null" >
        EXPRESS_ID,
      </if>
      <if test="expressNum != null" >
        EXPRESS_NUM,
      </if>
      <if test="payMent != null" >
        PAY_MENT,
      </if>
      <if test="payTime != null" >
        PAY_TIME,
      </if>
      <if test="shipName != null" >
        SHIP_NAME,
      </if>
      <if test="area != null" >
        AREA,
      </if>
      <if test="shipZip != null" >
        SHIP_ZIP,
      </if>
      <if test="shipTel != null" >
        SHIP_TEL,
      </if>
      <if test="shipEmail != null" >
        SHIP_EMAIL,
      </if>
      <if test="shipTime != null" >
        SHIP_TIME,
      </if>
      <if test="totalCost != null" >
        TOTAL_COST,
      </if>
      <if test="carriage != null" >
        CARRIAGE,
      </if>
      <if test="advance != null" >
        ADVANCE,
      </if>
      <if test="ebankMon != null" >
        EBANK_MON,
      </if>
      <if test="remark != null" >
        REMARK,
      </if>
      <if test="modifytime != null" >
        MODIFYTIME,
      </if>
      <if test="orderPoints != null" >
        ORDER_POINTS,
      </if>
      <if test="province != null" >
        PROVINCE,
      </if>
      <if test="city != null" >
        CITY,
      </if>
      <if test="address != null" >
        ADDRESS,
      </if>
      <if test="memberType != null" >
        MEMBER_TYPE,
      </if>
      <if test="billType != null" >
        BILL_TYPE,
      </if>
      <if test="billHead != null" >
        BILL_HEAD,
      </if>
      <if test="billContent != null" >
        BILL_CONTENT,
      </if>
      <if test="disabled != null" >
        DISABLED,
      </if>
      <if test="orderNum != null" >
        ORDER_NUM,
      </if>
      <if test="logisticsTel != null" >
        LOGISTICS_TEL,
      </if>
      <if test="dealId != null" >
        DEAL_ID,
      </if>
      <if test="dealType != null" >
        DEAL_TYPE,
      </if>
      <if test="hbNo != null">
     	 HB_NO,
      </if>
      <if test="hbNum != null">
      	HB_NUM,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="memberId != null" >
        #{memberId,jdbcType=VARCHAR},
      </if>
      <if test="createtime != null" >
        #{createtime,jdbcType=TIMESTAMP},
      </if>
      <if test="sourceType != null" >
        #{sourceType,jdbcType=VARCHAR},
      </if>
      <if test="saleType != null" >
        #{saleType,jdbcType=VARCHAR},
      </if>
      <if test="status != null" >
        #{status,jdbcType=VARCHAR},
      </if>
      <if test="payStatus != null" >
        #{payStatus,jdbcType=VARCHAR},
      </if>
      <if test="shipStatus != null" >
        #{shipStatus,jdbcType=VARCHAR},
      </if>
      <if test="keshStatus != null" >
        #{keshStatus,jdbcType=VARCHAR},
      </if>
      <if test="isDelivery != null" >
        #{isDelivery,jdbcType=VARCHAR},
      </if>
      <if test="expressId != null" >
        #{expressId,jdbcType=VARCHAR},
      </if>
      <if test="expressNum != null" >
        #{expressNum,jdbcType=VARCHAR},
      </if>
      <if test="payMent != null" >
        #{payMent,jdbcType=VARCHAR},
      </if>
      <if test="payTime != null" >
        #{payTime,jdbcType=TIMESTAMP},
      </if>
      <if test="shipName != null" >
        #{shipName,jdbcType=VARCHAR},
      </if>
      <if test="area != null" >
        #{area,jdbcType=VARCHAR},
      </if>
      <if test="shipZip != null" >
        #{shipZip,jdbcType=VARCHAR},
      </if>
      <if test="shipTel != null" >
        #{shipTel,jdbcType=VARCHAR},
      </if>
      <if test="shipEmail != null" >
        #{shipEmail,jdbcType=VARCHAR},
      </if>
      <if test="shipTime != null" >
        #{shipTime,jdbcType=TIMESTAMP},
      </if>
      <if test="totalCost != null" >
        #{totalCost,jdbcType=DECIMAL},
      </if>
      <if test="carriage != null" >
        #{carriage,jdbcType=DECIMAL},
      </if>
      <if test="advance != null" >
        #{advance,jdbcType=DECIMAL},
      </if>
      <if test="ebankMon != null" >
        #{ebankMon,jdbcType=DECIMAL},
      </if>
      <if test="remark != null" >
        #{remark,jdbcType=VARCHAR},
      </if>
      <if test="modifytime != null" >
        #{modifytime,jdbcType=TIMESTAMP},
      </if>
      <if test="orderPoints != null" >
        #{orderPoints,jdbcType=DECIMAL},
      </if>
      <if test="province != null" >
        #{province,jdbcType=VARCHAR},
      </if>
      <if test="city != null" >
        #{city,jdbcType=VARCHAR},
      </if>
      <if test="address != null" >
        #{address,jdbcType=VARCHAR},
      </if>
      <if test="memberType != null" >
        #{memberType,jdbcType=VARCHAR},
      </if>
      <if test="billType != null" >
        #{billType,jdbcType=VARCHAR},
      </if>
      <if test="billHead != null" >
        #{billHead,jdbcType=VARCHAR},
      </if>
      <if test="billContent != null" >
        #{billContent,jdbcType=VARCHAR},
      </if>
      <if test="disabled != null" >
        #{disabled,jdbcType=VARCHAR},
      </if>
      <if test="orderNum != null" >
        #{orderNum,jdbcType=VARCHAR},
      </if>
      <if test="logisticsTel != null" >
        #{logisticsTel,jdbcType=VARCHAR},
      </if>
      <if test="dealId != null" >
        #{dealId,jdbcType=VARCHAR},
      </if>
      <if test="dealType != null" >
        #{dealType,jdbcType=VARCHAR},
      </if>
      <if test="hbNo != null">
      	#{hbNo,jdbcType=VARCHAR},
      </if>
      <if test="hbNum != null">
      	#{hbNum,jdbcType=DECIMAL},
      </if>
    </trim>
  </insert>
  
  <!-- 根据订单Id和用户Id修改订单信息 -->
  <update id="updateByPrimaryKeySelective" parameterType="com.sanji.mall.model.Order" >
    update SJ_TB_ORDER
    <set >
      <if test="memberId != null" >
        MEMBER_ID = #{memberId,jdbcType=VARCHAR},
      </if>
      <if test="createtime != null" >
        CREATETIME = #{createtime,jdbcType=TIMESTAMP},
      </if>
      <if test="sourceType != null" >
        SOURCE_TYPE = #{sourceType,jdbcType=VARCHAR},
      </if>
      <if test="saleType != null" >
        SALE_TYPE = #{saleType,jdbcType=VARCHAR},
      </if>
      <if test="status != null" >
        STATUS = #{status,jdbcType=VARCHAR},
      </if>
      <if test="payStatus != null" >
        PAY_STATUS = #{payStatus,jdbcType=VARCHAR},
      </if>
      <if test="shipStatus != null" >
        SHIP_STATUS = #{shipStatus,jdbcType=VARCHAR},
      </if>
      <if test="keshStatus != null" >
        KESH_STATUS = #{keshStatus,jdbcType=VARCHAR},
      </if>
      <if test="isDelivery != null" >
        IS_DELIVERY = #{isDelivery,jdbcType=VARCHAR},
      </if>
      <if test="expressId != null" >
        EXPRESS_ID = #{expressId,jdbcType=VARCHAR},
      </if>
      <if test="expressNum != null" >
        EXPRESS_NUM = #{expressNum,jdbcType=VARCHAR},
      </if>
      <if test="payMent != null" >
        PAY_MENT = #{payMent,jdbcType=VARCHAR},
      </if>
      <if test="payTime != null" >
        PAY_TIME = #{payTime,jdbcType=TIMESTAMP},
      </if>
      <if test="shipName != null" >
        SHIP_NAME = #{shipName,jdbcType=VARCHAR},
      </if>
      <if test="area != null" >
        AREA = #{area,jdbcType=VARCHAR},
      </if>
      <if test="shipZip != null" >
        SHIP_ZIP = #{shipZip,jdbcType=VARCHAR},
      </if>
      <if test="shipTel != null" >
        SHIP_TEL = #{shipTel,jdbcType=VARCHAR},
      </if>
      <if test="shipEmail != null" >
        SHIP_EMAIL = #{shipEmail,jdbcType=VARCHAR},
      </if>
      <if test="shipTime != null" >
        SHIP_TIME = #{shipTime,jdbcType=TIMESTAMP},
      </if>
      <if test="totalCost != null" >
        TOTAL_COST = #{totalCost,jdbcType=DECIMAL},
      </if>
      <if test="carriage != null" >
        CARRIAGE = #{carriage,jdbcType=DECIMAL},
      </if>
      <if test="advance != null" >
        ADVANCE = #{advance,jdbcType=DECIMAL},
      </if>
      <if test="ebankMon != null" >
        EBANK_MON = #{ebankMon,jdbcType=DECIMAL},
      </if>
      <if test="remark != null" >
        REMARK = #{remark,jdbcType=VARCHAR},
      </if>
      <if test="modifytime != null" >
        MODIFYTIME = #{modifytime,jdbcType=TIMESTAMP},
      </if>
      <if test="orderPoints != null" >
        ORDER_POINTS = #{orderPoints,jdbcType=DECIMAL},
      </if>
      <if test="province != null" >
        PROVINCE = #{province,jdbcType=VARCHAR},
      </if>
      <if test="city != null" >
        CITY = #{city,jdbcType=VARCHAR},
      </if>
      <if test="address != null" >
        ADDRESS = #{address,jdbcType=VARCHAR},
      </if>
      <if test="memberType != null" >
        MEMBER_TYPE = #{memberType,jdbcType=VARCHAR},
      </if>
      <if test="billType != null" >
        BILL_TYPE = #{billType,jdbcType=VARCHAR},
      </if>
      <if test="billHead != null" >
        BILL_HEAD = #{billHead,jdbcType=VARCHAR},
      </if>
      <if test="billContent != null" >
        BILL_CONTENT = #{billContent,jdbcType=VARCHAR},
      </if>
      <if test="disabled != null" >
        DISABLED = #{disabled,jdbcType=VARCHAR},
      </if>
      <if test="orderNum != null" >
        ORDER_NUM = #{orderNum,jdbcType=VARCHAR},
      </if> 
      <if test="logisticsTel != null" >
        LOGISTICS_TEL = #{logisticsTel,jdbcType=VARCHAR},
      </if>
      <if test="dealId != null" >
        DEAL_ID = #{dealId,jdbcType=VARCHAR},
      </if>
      <if test="dealType != null" >
        DEAL_TYPE = #{dealType,jdbcType=VARCHAR},
      </if>
    </set>
    where ID = #{id,jdbcType=VARCHAR} and MEMBER_ID = #{memberId,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.sanji.mall.model.Order" >
    update SJ_TB_ORDER
    set MEMBER_ID = #{memberId,jdbcType=VARCHAR},
      CREATETIME = #{createtime,jdbcType=TIMESTAMP},
      SOURCE_TYPE = #{sourceType,jdbcType=VARCHAR},
      SALE_TYPE = #{saleType,jdbcType=VARCHAR},
      STATUS = #{status,jdbcType=VARCHAR},
      PAY_STATUS = #{payStatus,jdbcType=VARCHAR},
      SHIP_STATUS = #{shipStatus,jdbcType=VARCHAR},
      KESH_STATUS = #{keshStatus,jdbcType=VARCHAR},
      IS_DELIVERY = #{isDelivery,jdbcType=VARCHAR},
      EXPRESS_ID = #{expressId,jdbcType=VARCHAR},
      EXPRESS_NUM = #{expressNum,jdbcType=VARCHAR},
      PAY_MENT = #{payMent,jdbcType=VARCHAR},
      PAY_TIME = #{payTime,jdbcType=TIMESTAMP},
      SHIP_NAME = #{shipName,jdbcType=VARCHAR},
      AREA = #{area,jdbcType=VARCHAR},
      SHIP_ZIP = #{shipZip,jdbcType=VARCHAR},
      SHIP_TEL = #{shipTel,jdbcType=VARCHAR},
      SHIP_EMAIL = #{shipEmail,jdbcType=VARCHAR},
      SHIP_TIME = #{shipTime,jdbcType=TIMESTAMP},
      TOTAL_COST = #{totalCost,jdbcType=DECIMAL},
      CARRIAGE = #{carriage,jdbcType=DECIMAL},
      ADVANCE = #{advance,jdbcType=DECIMAL},
      EBANK_MON = #{ebankMon,jdbcType=DECIMAL},
      REMARK = #{remark,jdbcType=VARCHAR},
      MODIFYTIME = #{modifytime,jdbcType=TIMESTAMP},
      ORDER_POINTS = #{orderPoints,jdbcType=DECIMAL},
      PROVINCE = #{province,jdbcType=VARCHAR},
      CITY = #{city,jdbcType=VARCHAR},
      ADDRESS = #{address,jdbcType=VARCHAR},
      MEMBER_TYPE = #{memberType,jdbcType=VARCHAR},
      BILL_TYPE = #{billType,jdbcType=VARCHAR},
      BILL_HEAD = #{billHead,jdbcType=VARCHAR},
      BILL_CONTENT = #{billContent,jdbcType=VARCHAR},
      DISABLED = #{disabled,jdbcType=VARCHAR},
      ORDER_NUM = #{orderNum,jdbcType=VARCHAR},
      LOGISTICS_TEL = #{logisticsTel,jdbcType=VARCHAR},
      DEAL_ID = #{dealId,jdbcType=VARCHAR},
      DEAL_TYPE = #{dealType,jdbcType=VARCHAR}
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  
  <update id="cancelNoPayOrder">
    update SJ_TB_ORDER set STATUS = '3' where STATUS = '0' and PAY_MENT='0' and PAY_STATUS='0' and WALLET_PAY_NO is Null
  </update> 
  
  <update id="cancelNoPayOrderById" parameterType="java.lang.String">
    update SJ_TB_ORDER set STATUS = '3' where id= #{id,jdbcType=VARCHAR}
  </update> 
  
  <!-- 获取未支付成功的订单 -->
  <select id="gainPayUnsuccessfulOrder" resultMap="BaseResultMap">
  	select * from sj_tb_order o where o.STATUS = '0' and o.PAY_MENT='0' and o.PAY_STATUS='0' and o.CREATETIME &lt; sysdate and WALLET_PAY_NO is not null
  </select>
  
    <!-- 获取使用里钱包支付并且取消里订单的订单 -->
  <select id="gainWalletUnsuccessfulOrder" resultMap="BaseResultMap">
  	select * from sj_tb_order o where o.STATUS = '3' and o.PAY_STATUS='0' and o.CREATETIME BETWEEN sysdate-1 and sysdate and WALLET_PAY_NO is not null
  </select>
  
   <!-- 获取订单已经完结钱包还未完结的订单 -->
  <select id="gainOrderEndWalletNotEnd" resultMap="BaseResultMap">
  	select * from sj_tb_order o where o.STATUS = '0' and o.PAY_STATUS='1' and o.ship_status='3'  and o.ORDER_NUM BETWEEN '20160414164036113' and '20160420104045863' and WALLET_PAY_NO is not null
  </select>
  
  
  <!-- 根据订单的ID或者订单编号查询订单信息 只查询支付时所用的信息 -->
  <select id="gainOrderByID" resultMap="BaseResultMap" parameterType="java.lang.String">
  select o.id,o.total_cost,o.ship_name,o.ship_tel,o.ship_zip,o.order_num,o.ORDER_NUM,PAY_STATUS,
  o.WALLET_NUM,o.ACTUAL_PAY_NUM,
	(select R1."NAME" from SJ_TB_REGIONS R1 where R1."ID" = o.PROVINCE) as PNAME,
		(select R1."NAME" from SJ_TB_REGIONS R1 where R1."ID" = o.CITY) as CNAME,
		(select R1."NAME" from SJ_TB_REGIONS R1 where R1."ID" = o.area) ANAME,
	  o.address
	 from sj_tb_order o where o.disabled='false' and (o.id = #{id,jdbcType=VARCHAR} or o.ORDER_NUM = #{id,jdbcType=VARCHAR} or o.ECERP_NO = #{id,jdbcType=VARCHAR}) 
  </select>
  <select id="gainOrderALLByID" resultMap="orderDetailMap" parameterType="java.lang.String">
  	select <include refid="Base_Column_List_Detail"/> ,
  	(select R1."NAME" from SJ_TB_REGIONS R1 where R1."ID" = o.PROVINCE) as PNAME,
	(select R1."NAME" from SJ_TB_REGIONS R1 where R1."ID" = o.CITY) as CNAME,
	(select R1."NAME" from SJ_TB_REGIONS R1 where R1."ID" = o.area) ANAME,
	m.username as userName
  	from sj_tb_order o  
  	left join sj_tb_order_items items on o.id=items.ORDER_ID
  	left join sj_tb_goods_sku sku on items.TARGET_ID=sku.id 
  	left join sj_tb_goods goods on sku.goods_id=goods.id 
  	left join sj_tb_brand skuBrand on goods.brand_id = skuBrand.id
  	left join sj_tb_color skuCl on sku.color_id=skuCl.id
  	left join sj_tb_accessories acs on items.target_id=acs.id
  	left join sj_tb_brand acsBrand on acs.brand_id=acsBrand.id
  	left join sj_tb_color acsCl on acs.color_id=acsCl.id
  	left join sj_tb_members m on m.id = o.member_id
  	left join sj_tb_integral_goods pg on items.TARGET_ID=pg.id
  
  	left join sj_tb_gift gift on items.target_id=gift.id
  	left join sj_tb_accessories gacs on gift.GIFT_ID=gacs.id
  	left join sj_tb_brand gacsBrand on gacs.brand_id=gacsBrand.id
  	left join sj_tb_color gacsCl on gacs.color_id=gacsCl.id
  	where o.disabled='false' and o.id = #{id,jdbcType=VARCHAR}
  </select>
  
  <update id="updateEcerpById" parameterType="com.sanji.mall.model.Order">
  	update SJ_TB_ORDER
    <set >
      <if test="payMent != null" >
        PAY_MENT = #{payMent,jdbcType=VARCHAR},
      </if>
      <if test="ecerpNo != null" >
        ECERP_NO = #{ecerpNo,jdbcType=VARCHAR},
      </if>
      <if test="ecerpCreated != null" >
        ECERP_CREATED = #{ecerpCreated,jdbcType=VARCHAR},
      </if>
      <if test="ecerpError != null" >
        ECERP_ERROR = #{ecerpError,jdbcType=VARCHAR},
      </if>
    </set>
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  <!-- 更新支付状态 -->
  <update id="updatePayStatusById" parameterType="com.sanji.mall.model.Order">
  	update SJ_TB_ORDER
    <set >
      <if test="payStatus != null" >
        PAY_STATUS = #{payStatus,jdbcType=VARCHAR},
      </if>
      <if test="shipStatus != null" >
        SHIP_STATUS = #{shipStatus,jdbcType=VARCHAR},
      </if>
      <if test="signForTime != null" >
        SIGNFORTIME = #{signForTime,jdbcType=VARCHAR},
      </if>
      <if test="payMent != null" >
        PAY_MENT = #{payMent,jdbcType=VARCHAR},
      </if>
      <if test="payTime != null" >
        PAY_TIME = #{payTime,jdbcType=TIMESTAMP},
      </if>
      <if test="advance != null" >
        ADVANCE = #{advance,jdbcType=DECIMAL},
      </if>
      <if test="ebankMon != null" >
        EBANK_MON = #{ebankMon,jdbcType=DECIMAL},
      </if>
      <if test="dealId != null" >
        DEAL_ID = #{dealId,jdbcType=DECIMAL},
      </if>
      <if test="dealType != null" >
        DEAL_TYPE = #{dealType,jdbcType=DECIMAL},
      </if>
    </set>
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  <update id="updateShipAdd" parameterType="com.sanji.mall.model.Order">
  update SJ_TB_ORDER
    <set >
      <if test="shipName != null" >
        SHIP_NAME = #{shipName,jdbcType=VARCHAR},
      </if>
      <if test="area != null" >
        AREA = #{area,jdbcType=VARCHAR},
      </if>
      <if test="shipZip != null" >
        SHIP_ZIP = #{shipZip,jdbcType=VARCHAR},
      </if>
      <if test="shipTel != null" >
        SHIP_TEL = #{shipTel,jdbcType=VARCHAR},
      </if>
      <if test="shipEmail != null" >
        SHIP_EMAIL = #{shipEmail,jdbcType=VARCHAR},
      </if>
      <if test="province != null" >
        PROVINCE = #{province,jdbcType=VARCHAR},
      </if>
      <if test="city != null" >
        CITY = #{city,jdbcType=VARCHAR},
      </if>
      <if test="address != null" >
        ADDRESS = #{address,jdbcType=VARCHAR},
      </if>
    </set>
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  
  <!-- 查找状态正常，线上付款，已付款，未发货并且发货时间为空的订单信息 -->
  <select id="noShipGoods" resultMap="BaseResultMap" >
  	select o.id,o.order_num from sj_tb_order o where o.status='0' and o.pay_ment='0' and o.pay_status='1' and o.ship_status='0' and o.ship_time is null
  </select>
  
  <!-- 自动确认收货 -->
  <update id="autoAffirmReceiving">
  	update sj_tb_order o set o.ship_status='3',o.signfortime=sysdate where o.status='0' and o.pay_ment='0' and o.pay_status='1' and o.ship_status='1' and TO_CHAR(o.ship_time,'yyyy-mm-dd HH24:MI:SS') &lt; TO_CHAR(sysdate-3,'yyyy-mm-dd HH24:MI:SS')
  </update>
  
  <!-- 查询未发货的订单列表 -->
  <select id="getNoShipOrder" resultType="map" >
  	select o.id,o.ecerp_no ecerpNo,o.order_num ORDERNUM from sj_tb_order o where o.ship_status='0' and o.status='0' and o.disabled='false'
  </select>
  <!-- 自动确认收货 -->
  <update id="autoShip">
  	update sj_tb_order o set o.ship_status='1',o.ship_time=sysdate where o.ecerp_no=#{erpNo,jdbcType=VARCHAR}
  </update>
  
  <!-- 已签收没有签收时间的订单自动修改成订单创建后2天自动签收时间 -->
  <update id="autoSingForTime">
  	   update sj_tb_order o set o.signfortime = o.createtime+2 where o.signfortime is NUll and o.status='0' and o.pay_status='1' and o.ship_status='3'
  </update>
  
  <!-- ultlon项目接口 -->
  
   <!-- 根据用户名和订单管易编号和商品id获取订单信息  --><!-- 后期修改，查找条件删除用户id这个条件 -->
   <select id="selectByUidAndErpAndSkunum" parameterType="java.lang.String" resultType="map">
	    select o.id orderId,o.order_num orderNum,o.ship_name shipName,o.ship_tel shipTel,
	       o.address,o.signfortime,o.ecerp_no ecerpNo,o.createtime,o.SIGNFORTIME,
	       oi.id itemId, oi.deal_price dealPrice,oi.nums,oi.target_id targetId,
	       m.id userId,m.USERNAME,
		     s.price skuPrice,s.sku_num skuNum,s.id skuId,s.edition,s.standard,s.storage,
         g.name goodsName,c.color_name colorName,p.pic_src picSrc,b.name brandName,
         (select R1."NAME" from SJ_TB_REGIONS R1 where R1."ID" = o.PROVINCE) as PNAME,
      	 (select R1."NAME" from SJ_TB_REGIONS R1 where R1."ID" = o.CITY) as CNAME,
      	 (select R1."NAME" from SJ_TB_REGIONS R1 where R1."ID" = o.area) ANAME
	       from sj_tb_order o
	       left join sj_tb_order_items oi on o.id=oi.order_id
	       left join sj_tb_goods_sku s on oi.target_id=s.id
         left join sj_tb_goods g on s.goods_id=g.id
         left join sj_tb_color c on s.color_id=c.id
         left join sj_tb_goods_pic p on s.id=p.sku_id
         left join Sj_Tb_Brand b on g.brand_id=b.id
         left join sj_tb_members m on o.MEMBER_ID = m.id
	       where  o.order_num=#{ecerpNo,jdbcType=VARCHAR} and s.sku_num=#{skuNum,jdbcType=VARCHAR}
  </select>
  
  <select id="selectErpnoById" parameterType="java.lang.String" resultType="java.lang.String">
	   select o.ecerp_no from sj_tb_order o where o.id=#{id,jdbcType=VARCHAR}
    </select>
  
  <!-- 通过用户id获取未评论的订单金额 -->
  <select id="getNoCommentById" parameterType="java.lang.String" resultMap="BaseResultMap">
  	select o.id as id,oi.deal_price as totalCost from sj_tb_order_items oi
	left join sj_tb_order o on oi.order_id = o.id
	left join sj_tb_members m on o.member_id=m.id
    where oi.target_type='sku' and o.pay_status='1' and o.sale_type='0' and o.ship_status='3' and o.order_points='0'
    and o.pay_time between to_date('2015/8/10 00:00:00','yyyy/mm/dd hh24:mi:ss')
    and to_date('2015/9/15 23:59:59','yyyy/mm/dd hh24:mi:ss') and o.member_id=#{memberId,jdbcType=VARCHAR}
  </select>
  
  <!-- 根据订单id更新订单积分 -->
  <update id="updateOrderPointById" >
  	update sj_tb_order 
  	<set>
  		<if test="point != null" >
        	order_points = #{point,jdbcType=INTEGER}
		</if>
		
  	</set>
    where id = #{orderId,jdbcType=VARCHAR}
  </update>
  
    <!-- 统计已经购买的活动商品数量 -->
  <select id="gainYetBuyNum" resultType="Integer" parameterType="java.lang.String" >
    select sum(i.NUMS) buyNum from SJ_TB_ORDER o 
		join sj_tb_order_items i on i.ORDER_ID=o.id
		join SJ_TB_GOODS_SKU s on i.TARGET_ID=s.id
		where s.GOODS_ID=#{goodsId,jdbcType=VARCHAR} and trunc(sysdate)=trunc(o.CREATETIME)  and o.STATUS='0'
		<if test="memberId != null" >
            and o.MEMBER_ID=#{memberId,jdbcType=VARCHAR}
      </if>
  </select> 
  
      <!-- 查询订单是否有活动商品 -->
  <select id="checkerOrderThereHdGoods" resultType="Integer" parameterType="java.lang.String" >
	  select count(g.id) count from sj_tb_goods g
		LEFT join sj_tb_goods_sku s on g.id=s.goods_id
		left join SJ_TB_ORDER_ITEMS i on s.id=i.target_id
		where  exists (select sr.GOODS_ID from sj_tb_shopping_rush sr where sr.user_name=#{userName,jdbcType=VARCHAR} and sr.goods_id=g.id) 
		and i.ORDER_ID=#{orderId,jdbcType=VARCHAR}
  </select> 
  
  
  
</mapper>